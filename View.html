<!DOCTYPE html>
<html>
<head>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <style>
    table {border-collapse: collapse; width: 45%; font-family: Arial, sans-serif;}
    th, td {border: 1px solid #ddd; padding: 10px; text-align: left;}
    th {background-color: #f2f2f2; font-weight: bold;}
    tr:nth-child(even) {background-color: #f9f9f9;}
    tr:hover {background-color: #f5f5f5;}
    button {padding: 5px 10px; cursor: pointer; border: none; border-radius: 3px; margin-right: 5px;}
    .edit-btn {background-color: #4CAF50; color: white;}
    .edit-btn:hover {background-color: #45a049;}
    .proposal-btn {background-color: #FF9800; color: white;}
    .proposal-btn:hover {background-color: #e68900;}
    .generate-proposal-btn {background-color: #007bff; color: white;}
    .generate-proposal-btn:hover {background-color: #0069d9;}
    .date-btn {background-color: #2196F3; margin-left: 10px; vertical-align: middle;}
    .date-btn:hover {background-color: #1e88e5;}
    .modal {display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);}
    .modal-content {background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 70%; max-width: 1100px; min-width: 800px; max-height: 85vh; overflow-y: auto;}
    .modal-content table th, .modal-content table td {min-width: 150px; vertical-align: top;}
    .modal-content table {width: 100%;}
    .modal-content table th {text-align: center;}
    .close {color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}
    .close:hover {color: black;}
    select, textarea, input[type="text"] {padding: 5px; box-sizing: border-box; resize: vertical; vertical-align: middle; display: inline-block; width: 100%;}
    .input-container {display: flex; align-items: center;}
    .filter-container {margin-bottom: 20px; padding: 10px; background-color: #f2f2f2; border-radius: 5px; display: flex; align-items: center;}
    .filter-container label {margin-right: 10px;}
    .filter-container select#filterColumn {width: 20em;}
    .filter-container input#filterInput {width: 20em;}
    #pasiulymai_su_pasiulymu_kiekiu {margin-top: 20px;}
    #pasiulymai {display: flex; flex-direction: row; gap: 20px;}
    #pasiulymai table, .pasiulymai_inline table {
      flex: 1;
      table-layout: fixed; /* Svarbiausias pakeitimas: nurodo naudoti fiksuotą išdėstymą */
    }
    #pasiulymu_kiekis {margin-bottom: 10px; width: 100px;}
    /* Nustatome maksimalų plotį pasiūlymo lentelių "Reikšmė" stulpeliui */
    #pasiulymai table th, 
    #pasiulymai table td,
    .pasiulymai_inline table th,
    .pasiulymai_inline table td {
      width: 50px;
      max-width: 50px;
      word-wrap: break-word; /* Užtikrina, kad ilgas tekstas būtų perkeltas */
    }
    .pasiulymu_kiekis_select {
      width: 100px;
    }
  </style>
</head>
<body>

<div class="filter-container">
  <label>Filtruoti pagal stulpelį: </label>
  <select id="filterColumn">
    <option value="all">Visi stulpeliai</option>
    <? displayNames.forEach(function(name, index) { ?>
      <option value="<?= index ?>"><?= name ?></option>
    <? }); ?>
  </select>
  <input type="text" id="filterInput" placeholder="Įveskite filtravimo tekstą">
</div>

<table id="dataTable">
  <tr>
    <th>Veiksmai</th>
    <? displayNames.forEach(function(displayName) { ?>
      <th><?= displayName ?></th>
    <? }); ?>
  </tr>
  
  <? for (var i = 1; i < formattedData.length; i++) { ?>
    <tr data-original-index="<?= i ?>">
      <? 
        var uniqueId = formattedData[i][idIndex] ? formattedData[i][idIndex].toString() : '';
      ?>
      <td><!-- <button class="edit-btn" onclick="showModal(<?= i ?>)">Edit</button> --><button class="proposal-btn" onclick="showProposalModal(<?= i ?>)">Pasiūlymas</button></td>
      <? columnIndices.forEach(function(idx) { ?>
        <td><?= formattedData[i][idx] ?></td>
      <? }); ?>
    </tr>
  <? } ?>
</table>

<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('myModal')">&times;</span>
    <h2>Eilutės duomenys</h2>
    <table id="modalTable"></table>
    <button id="saveChangesBtn">Išsaugoti</button>
  </div>
</div>

<div id="proposalModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('proposalModal')">&times;</span>
    <h2>Pasiūlymo duomenys</h2>
    <div id="pasiulymai_su_pasiulymu_kiekiu">
      <label for="pasiulymu_kiekis">Pasiūlymų kiekis:</label>
      <select id="pasiulymu_kiekis"></select>
      <div id="pasiulymu_nuorodos_container" style="margin-top: 15px; display: none;">
        <strong>Sugeneruotų pasiūlymų nuorodos:</strong>
        <div id="pasiulymu_nuorodos_list" style="margin-top: 5px; word-break: break-all;"></div>
      </div>
      <div id="pasiulymai">
        <table id="pasiulymas1Table"></table>
        <table id="pasiulymas2Table"></table>
        <table id="pasiulymas3Table"></table>
      </div>
    </div>
    <button id="saveProposalBtn" class="edit-btn">Išsaugoti</button>
    <button id="generateProposalBtn" class="generate-proposal-btn">Generuoti pasiūlymą</button>
  </div>
</div>

<script>
  console.log("Script loaded");
  var kainosValues = <?!= JSON.stringify(kainosValues) ?>;
  var allProposalColumns = <?!= JSON.stringify(allProposalColumns) ?>;
  var idIndex = <?!= idIndex ?>;
  var fullNameIndex = <?!= fullNameIndex ?>;
  var emailIndex = <?!= emailIndex ?>;
  var linksIndex = <?!= linksIndex ?>;
  var formattedData = <?!= JSON.stringify(formattedData) ?>;
  var autoDisplayConfig = <?!= JSON.stringify(autoDisplayConfig) ?>;
  
  $(document).ready(function() {
    console.log("jQuery and jQuery UI loaded");
    $(".datepicker").datepicker({
      dateFormat: "yy-mm-dd", showButtonPanel: true, changeMonth: true, changeYear: true
    });
    $("#filterInput").on("input", function() {
      applyFilter();
    });
    $("#filterColumn").on("change", function() {
      applyFilter();
    });

    // Pridedame paspaudimo ant eilutės funkcionalumą
    $('#dataTable').on('click', 'tbody tr', function(event) {
      // Ignoruojame paspaudimus, kurie įvyko redagavimo formos (.edit-row) viduje,
      // arba ant mygtukų/nuorodų pačioje duomenų eilutėje.
      if ($(event.target).closest('.edit-row').length) { return; }
      if ($(event.target).is('button, a') || $(event.target).closest('button, a').length) {
        return;
      }
      toggleInlineEdit(this);
    });
  });

  function applyFilter() {
    var filterColumn = $("#filterColumn").val();
    var filterValue = $("#filterInput").val().toLowerCase();
    // Pridedame originalų indeksą, kad galėtume teisingai iškviesti modalinius langus
    var data = formattedData.slice(1).map(function(row, index) {
      row.originalIndex = index + 1; // +1, nes praleidžiame antraštę
      return row;
    });
    var indices = <?!= JSON.stringify(columnIndices) ?>;
    var displayNames = <?!= JSON.stringify(displayNames) ?>;
    var table = document.getElementById("dataTable");
    table.innerHTML = "";
    var html = "<tr><th>Veiksmai</th>";
    for (var i = 0; i < displayNames.length; i++) {
      html += "<th>" + displayNames[i] + "</th>";
    }
    html += "</tr>";
    for (var i = 0; i < data.length; i++) {
      var row = data[i];
      var matches = filterColumn === "all" ? row.some(function(cell) { return cell && cell.toString().toLowerCase().includes(filterValue); }) : 
        row[indices[filterColumn]] && row[indices[filterColumn]].toString().toLowerCase().includes(filterValue);
      if (matches) {
        var originalIndex = data[i].originalIndex;
        var uniqueId = formattedData[originalIndex][idIndex] ? formattedData[originalIndex][idIndex].toString() : '';

        html += "<tr data-original-index='" + originalIndex + "'><td><!-- <button class=\"edit-btn\" onclick=\"showModal(" + originalIndex + ")\">Edit</button> --><button class=\"proposal-btn\" onclick=\"showProposalModal(" + originalIndex + ")\">Pasiūlymas</button></td>";
        for (var j = 0; j < indices.length; j++) {
          var value = row[indices[j]] || "";
          html += "<td>" + value + "</td>";
        }
        html += "</tr>";
      }
    }
    table.innerHTML = html;
  }

  function updateDependentFields(tableIndex) {
    // Ši funkcija nebenaudojama, nes skaičiavimai perkelti į serverio pusę (Google Sheets formules).
    // Paliekama tuščia, kad išvengtume klaidų, jei ji vis dar kur nors iškviečiama.
    console.log("updateDependentFields is deprecated.");
  }

  function showModal(index) {
    console.log("showModal called with index: " + index);
    var rowIndex = index;
    var data = <?!= JSON.stringify(formattedData.slice(1)) ?>;
    var group1Columns = <?!= JSON.stringify(group1Columns) ?>;
    var group2Columns = <?!= JSON.stringify(group2Columns) ?>;
    var modal = document.getElementById("myModal");
    var modalTable = document.getElementById("modalTable");
    var saveBtn = document.getElementById("saveChangesBtn");
    if (!modal || !modalTable) { console.error("Modal or issiokantiTable not found"); return; }
    modalTable.innerHTML = "";
    var html = "<tr><th>Pavadinimas 1</th><th>Reikšmė 1</th><th>Pavadinimas 2</th><th>Reikšmė 2</th></tr>"; // Note: 'issiokanti' might be a typo for 'iššokanti'
    var maxRows = Math.max(group1Columns.length, group2Columns.length);
    for (var i = 0; i < maxRows; i++) {
      var name1 = i < group1Columns.length && group1Columns[i] ? group1Columns[i].displayName : "";
      var value1 = i < group1Columns.length && group1Columns[i] ? (data[rowIndex-1][group1Columns[i].index] || "") : "";
      var inputField1 = (i < group1Columns.length && group1Columns[i] && group1Columns[i].editable) 
                        ? createInputField(group1Columns[i], value1) 
                        : ("<div class=\"" + (group1Columns[i] ? group1Columns[i].columnName : '') + "_reiksme\">" + (value1 ? value1.toString() : "") + "</div>");

      var name2 = i < group2Columns.length && group2Columns[i] ? group2Columns[i].displayName : "";
      var value2 = i < group2Columns.length && group2Columns[i] ? (data[rowIndex-1][group2Columns[i].index] || "") : "";
      var inputField2 = (i < group2Columns.length && group2Columns[i] && group2Columns[i].editable) 
                        ? createInputField(group2Columns[i], value2) 
                        : ("<div class=\"" + (group2Columns[i] ? group2Columns[i].columnName : '') + "_reiksme\">" + (value2 ? value2.toString() : "") + "</div>");

      html += "<tr><td>" + name1 + "</td><td>" + inputField1 + "</td><td>" + name2 + "</td><td>" + inputField2 + "</td></tr>";
    }
    console.log("issiokantiTable HTML: " + html);
    modalTable.innerHTML = html;
    $(".datepicker").datepicker({ dateFormat: "yy-mm-dd", showButtonPanel: true, changeMonth: true, changeYear: true });
    saveBtn.setAttribute('onclick', 'saveChanges(' + rowIndex + ')');
    modal.style.display = "block";
  }

  function showProposalModal(index) {
    console.log("showProposalModal called with index: " + index);

    var rowIndex = index;
    var data = <?!= JSON.stringify(formattedData.slice(1)) ?>;
    var proposalColumns = <?!= JSON.stringify(proposalColumns) ?>;
    var pasiulymuKiekisOptions = <?!= JSON.stringify(pasiulymuKiekisOptions) ?>;
    var pasiulymuKiekisIndex = <?!= pasiulymuKiekisIndex ?>;
    var modal = document.getElementById("proposalModal");
    var modalTable1 = document.getElementById("pasiulymas1Table");
    var modalTable2 = document.getElementById("pasiulymas2Table");
    var modalTable3 = document.getElementById("pasiulymas3Table");
    var pasiulymuKiekisSelect = document.getElementById("pasiulymu_kiekis");    
    var linksContainer = document.getElementById("pasiulymu_nuorodos_container");
    var linksListDiv = document.getElementById("pasiulymu_nuorodos_list");
    var modalTitle = modal.querySelector('h2');
    var saveBtn = document.getElementById("saveProposalBtn");
    var generateBtn = document.getElementById("generateProposalBtn");
    if (!modal || !modalTable1 || !modalTable2 || !pasiulymuKiekisSelect) { console.error("Proposal modal, pasiulymas tables, or pasiulymu_kiekis not found"); return; }
    modalTable1.innerHTML = "";
    modalTable2.innerHTML = "";

    // Atnaujiname modalinio lango antraštę
    var currentRowData = data[rowIndex-1];
    var fullName = fullNameIndex !== -1 ? currentRowData[fullNameIndex] : '';
    var email = emailIndex !== -1 ? currentRowData[emailIndex] : '';
    var titleText = 'Pasiūlymo duomenys';
    if (fullName) titleText += ': ' + fullName;
    if (email) titleText += ' (' + email + ')';
    modalTitle.textContent = titleText;

    // Nustatome mygtukų onclick atributus
    var uniqueId = currentRowData[idIndex] ? currentRowData[idIndex].toString() : '';
    generateBtn.setAttribute('onclick', "generateProposal('" + uniqueId + "')");

    // Atvaizduojame pasiūlymų nuorodas
    if (linksIndex !== -1) {
      var linksValue = currentRowData[linksIndex];
      if (linksValue) {
        var linksArray = linksValue.split('\n').filter(link => link.trim() !== '');
        var linksHtml = linksArray.map(function(linkData, i) {
          var parts = linkData.split('|');
          var url = parts[0];
          var date = parts.length > 1 ? parts[1] : '';
          var dateHtml = date ? ' <span style="color: #888; font-size: 0.9em;">(' + date + ')</span>' : '';

          return (i + 1) + '. <a href="' + url + '" target="_blank">' + url + '</a>' + dateHtml;
        }).join('<br>');
        linksListDiv.innerHTML = linksHtml;
        linksContainer.style.display = 'block';
      } else {
        linksContainer.style.display = 'none';
      }
    }

    var html1 = "<tr><th>Pavadinimas</th><th>Reikšmė</th></tr>";
    var html2 = "<tr><th>Pavadinimas</th><th>Reikšmė</th></tr>";
    var html3 = "<tr><th>Pavadinimas</th><th>Reikšmė</th></tr>";
    for (var i = 0; i < proposalColumns.length; i++) {
      var name = proposalColumns[i].displayName || "";
      var baseColumnName = proposalColumns[i].columnName.replace(/1$/, '');

      // Paimame reikšmes kiekvienam pasiūlymui atskirai
      var value1 = data[rowIndex-1][allProposalColumns.find(c => c.columnName === baseColumnName + '1')?.index] || "";
      var value2 = data[rowIndex-1][allProposalColumns.find(c => c.columnName === baseColumnName + '2')?.index] || "";
      var value3 = data[rowIndex-1][allProposalColumns.find(c => c.columnName === baseColumnName + '3')?.index] || "";

      // Numatytosios reikšmės logika
      if (baseColumnName === "pasirinkite_kw" && !value1) value1 = "10";

      var inputField1 = "";
      var inputField2 = "";
      var inputField3 = "";

      // Surandame auto-update konfigūraciją kiekvienam laukeliui atskirai
      var autoUpdateCellTemplate1 = allProposalColumns.find(c => c.columnName === baseColumnName + '1')?.autoUpdateCell;
      var autoUpdateCellTemplate2 = allProposalColumns.find(c => c.columnName === baseColumnName + '2')?.autoUpdateCell;
      var autoUpdateCellTemplate3 = allProposalColumns.find(c => c.columnName === baseColumnName + '3')?.autoUpdateCell;

      // Dinamiškai sukuriame onchange atributą, jei reikia
      var onChangeAttr1 = (autoUpdateCellTemplate1 && autoUpdateCellTemplate1.includes('!')) ? `updateProposalSheetCell(1, '${autoUpdateCellTemplate1.split('!')[1]}', this.value);` : '';
      var onChangeAttr2 = (autoUpdateCellTemplate2 && autoUpdateCellTemplate2.includes('!')) ? `updateProposalSheetCell(2, '${autoUpdateCellTemplate2.split('!')[1]}', this.value);` : '';
      var onChangeAttr3 = (autoUpdateCellTemplate3 && autoUpdateCellTemplate3.includes('!')) ? `updateProposalSheetCell(3, '${autoUpdateCellTemplate3.split('!')[1]}', this.value);` : '';

      if (proposalColumns[i].editable) {
        console.log("Processing proposalColumns[" + i + "]: " + baseColumnName);
        // Surandame teisingas parinktis iš allProposalColumns
        var options1 = allProposalColumns.find(c => c.columnName === baseColumnName + '1')?.options || [];
        var options2 = allProposalColumns.find(c => c.columnName === baseColumnName + '2')?.options || [];
        var options3 = allProposalColumns.find(c => c.columnName === baseColumnName + '3')?.options || [];
        if (options1.length > 0) {
          inputField1 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><select id=\"input_" + baseColumnName + "_1\" size=\"1\" onchange=\"" + onChangeAttr1 + "\">" + 
            "<option value=\"\"" + (value1 === "" ? " selected" : "") + "></option>" + options1.map(opt => "<option value=\"" + opt + "\"" + (value1.toString() === opt ? " selected" : "") + ">" + opt + "</option>").join("") + "</select></div></div>";
          inputField2 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><select id=\"input_" + baseColumnName + "_2\" size=\"1\" onchange=\"" + onChangeAttr2 + "\">" + 
            "<option value=\"\"" + (value2 === "" ? " selected" : "") + "></option>" + options2.map(opt => "<option value=\"" + opt + "\"" + (value2.toString() === opt ? " selected" : "") + ">" + opt + "</option>").join("") + "</select></div></div>";
          inputField3 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><select id=\"input_" + baseColumnName + "_3\" size=\"1\" onchange=\"" + onChangeAttr3 + "\">" + 
            "<option value=\"\"" + (value3 === "" ? " selected" : "") + "></option>" + options3.map(opt => "<option value=\"" + opt + "\"" + (value3.toString() === opt ? " selected" : "") + ">" + opt + "</option>").join("") + "</select></div></div>";
        } else {
          inputField1 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><textarea id=\"input_" + baseColumnName + "_1\" rows=\"1\" placeholder=\"Įveskite reikšmę\" onchange=\"" + onChangeAttr1 + "\">" + (value1 ? value1.toString() : "") + "</textarea></div></div>";
          inputField2 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><textarea id=\"input_" + baseColumnName + "_2\" rows=\"1\" placeholder=\"Įveskite reikšmę\" onchange=\"" + onChangeAttr2 + "\">" + (value2 ? value2.toString() : "") + "</textarea></div></div>";
          inputField3 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><textarea id=\"input_" + baseColumnName + "_3\" rows=\"1\" placeholder=\"Įveskite reikšmę\" onchange=\"" + onChangeAttr3 + "\">" + (value3 ? value3.toString() : "") + "</textarea></div></div>";
        }
      } else {
        console.log("Processing proposalColumns[" + i + "] (non-editable): " + proposalColumns[i].columnName);
        inputField1 = "<div class=\"" + proposalColumns[i].columnName.replace(/1$/, '') + "_reiksme\" id=\"input_" + proposalColumns[i].columnName.replace(/1$/, '') + "_1\">" + (value1 ? value1.toString() : "") + "</div>";
        inputField2 = "<div class=\"" + proposalColumns[i].columnName.replace(/1$/, '') + "_reiksme\" id=\"input_" + proposalColumns[i].columnName.replace(/1$/, '') + "_2\">" + (value2 ? value2.toString() : "") + "</div>";
        inputField3 = "<div class=\"" + proposalColumns[i].columnName.replace(/1$/, '') + "_reiksme\" id=\"input_" + proposalColumns[i].columnName.replace(/1$/, '') + "_3\">" + (value3 ? value3.toString() : "") + "</div>";
      }
      html1 += "<tr><td>" + name + "1</td><td>" + inputField1 + "</td></tr>";
      html2 += "<tr><td>" + name + "2</td><td>" + inputField2 + "</td></tr>";
      html3 += "<tr><td>" + name + "3</td><td>" + inputField3 + "</td></tr>";
    }
    console.log("pasiulymas1Table HTML: " + html1);
    console.log("pasiulymas2Table HTML: " + html2);
    console.log("pasiulymas3Table HTML: " + html3);
    modalTable1.innerHTML = html1;
    modalTable2.innerHTML = html2;
    modalTable3.innerHTML = html3;

    // --- Nuoseklus duomenų sinchronizavimas ir auto-atvaizdavimo eilučių įkėlimas ---
    if (autoDisplayConfig && autoDisplayConfig.length > 0) {
      var syncData = <?!= JSON.stringify(formattedData.slice(1)) ?>;
      var syncAllProposalColumns = <?!= JSON.stringify(allProposalColumns) ?>;

      // Ciklas per pasiūlymus (1, 2, 3)
      for (let i = 1; i <= 3; i++) {
        // 1. Paruošiame duomenis sinchronizavimui šiam konkrečiam pasiūlymui
        let dataToSync = [];
        proposalColumns.forEach(function(pCol) {
          if (pCol.autoUpdateCell && pCol.autoUpdateCell.includes('!')) {
            var baseColumnName = pCol.columnName;
            var cellAddress = pCol.autoUpdateCell.split('!')[1];
            var fullColumnName = baseColumnName + i;
            var sourceCol = syncAllProposalColumns.find(c => c.columnName === fullColumnName);
            if (sourceCol) {
              var value = syncData[index - 1][sourceCol.index] || '';
              dataToSync.push({ cellAddress: cellAddress, value: value });
            }
          }
        });

        // 2. Iškviečiame serverio funkciją
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success && response.autoDisplayValues) {
              console.log(`Gautos auto-atvaizdavimo reikšmės pasiūlymui ${i}:`, response.autoDisplayValues);
              var tableId = "pasiulymas" + i + "Table";
              var $table = $("#" + tableId);
              // Išvalome senas eilutes, jei kartais jos liktų
              $table.find('.auto-display-row').remove(); 
              response.autoDisplayValues.forEach(function(item, itemIndex) {
                var newRow = "<tr class='auto-display-row' data-item-index='" + itemIndex + "'>" +
                               "<td>" + item.pavadinimas + "</td>" +
                               "<td>" + item.reiksme + "</td>" +
                             "</tr>";
                $table.append(newRow);
              });
            }
          })
          .withFailureHandler(function(err) { console.error(`Klaida sinchronizuojant pasiūlymą ${i}: ` + err); })
          .syncAndGetInitialData(i, dataToSync);
      }
    }

    var pasiulymuKiekisValue = pasiulymuKiekisIndex !== -1 ? (data[rowIndex-1][pasiulymuKiekisIndex] || "").toString() : "";
    pasiulymuKiekisSelect.innerHTML = "<option value=\"\"" + (pasiulymuKiekisValue === "" ? " selected" : "") + "></option>" + pasiulymuKiekisOptions.map(opt => "<option value=\"" + opt + "\"" + (pasiulymuKiekisValue.toString() === opt ? " selected" : "") + ">" + opt + "</option>").join("");
    
    function toggleProposalTables() {
      var count = pasiulymuKiekisSelect.value;
      $('#pasiulymas1Table').toggle(count >= 1);
      $('#pasiulymas2Table').toggle(count >= 2);
      $('#pasiulymas3Table').toggle(count >= 3);
    }

    $(pasiulymuKiekisSelect).off('change').on('change', toggleProposalTables);
    
    toggleProposalTables();

    saveBtn.setAttribute('onclick', 'saveProposalChanges(' + rowIndex + ')');
    modal.style.display = "block";
  }

  function updateProposalSheetCell(sheetNumber, cellAddress, value) {
    console.log("Auto-updating sheet " + sheetNumber + ", cell " + cellAddress + " with value: " + value);
    google.script.run
      .withSuccessHandler(function(response) {
        if (response && response.success && response.autoDisplayValues) {
          console.log("Gautos atnaujintos auto-atvaizdavimo reikšmės pasiūlymui " + sheetNumber + ":", response.autoDisplayValues);
          
          // Nustatome teisingą selektorių. Modaliniame lange lentelės turi ID,
          // o įterptinėje formoje (.edit-row) - klases.
          var tableSelector = '#proposalModal .pasiulymas' + sheetNumber + 'Table, .edit-row .pasiulymas' + sheetNumber + 'Table';
          var $table = $(tableSelector);

          if ($table.length === 0) {
            console.error("Nepavyko rasti lentelės su selektoriumi: " + tableSelector);
            return;
          }

          // Atnaujiname kiekvieną eilutę su naujomis reikšmėmis
          response.autoDisplayValues.forEach(function(item, itemIndex) {
            var $row = $table.find(".auto-display-row[data-item-index='" + itemIndex + "']");
            $row.find('td').eq(0).text(item.pavadinimas); // Atnaujiname pavadinimą
            $row.find('td').eq(1).text(item.reiksme);      // Atnaujiname reikšmę
          });
        }
      })
      .withFailureHandler(function(err) { console.error("Klaida automatiškai atnaujinant skaičiuoklės langelį: " + err.message); })
      .updateProposalSheetCell(sheetNumber, cellAddress, value);
  }


  function closeModal(modalId) {
    console.log("closeModal called for: " + modalId);
    var modal = document.getElementById(modalId);
    if (modal) modal.style.display = "none";
  }

  function saveChanges(rowIndex) {
    console.log("saveChanges called for row index: " + rowIndex);
    var updates = {};
    var group1Columns = <?!= JSON.stringify(group1Columns) ?>;
    var group2Columns = <?!= JSON.stringify(group2Columns) ?>;
    for (var i = 0; i < group1Columns.length; i++) {
      if (group1Columns[i].editable) {
        var input = document.getElementById("input_" + group1Columns[i].columnName);
        if (input) {
          var value = input.value;
          if (group1Columns[i].hasDatePicker && value) {
            value = group1Columns[i].isDate ? value : value + " 00:00";
          }
          updates[group1Columns[i].index] = { value: value, isDate: group1Columns[i].isDateTime || group1Columns[i].isDate };
        }
      }
    }
    for (var i = 0; i < group2Columns.length; i++) {
      if (group2Columns[i].editable) {
        var input = document.getElementById("input_" + group2Columns[i].columnName);
        if (input) {
          var value = input.value;
          if (group2Columns[i].hasDatePicker && value) {
            value = group2Columns[i].isDate ? value : value + " 00:00";
          }
          updates[group2Columns[i].index] = { value: value, isDate: group2Columns[i].isDateTime || group2Columns[i].isDate };
        }
      }
    }
    google.script.run
      .withSuccessHandler(function() { alert("Duomenys išsaugoti!"); closeModal("myModal"); location.reload(); })
      .withFailureHandler(function(err) { alert("Klaida išsaugant: " + err); })
      .updateSheet1(rowIndex, updates);
  }

  function saveProposalChanges(rowIndex) {
    console.log("saveProposalChanges called for row index: " + rowIndex);
    var pasiulymuKiekis = parseInt(document.getElementById("pasiulymu_kiekis")?.value || "1");
    var updates = {};
    var proposalColumns = <?!= JSON.stringify(proposalColumns) ?>;

    // Atnaujiname 'pasiulymu_kiekis' stulpelį
    if (<?!= pasiulymuKiekisIndex ?> !== -1) {
      updates[<?!= pasiulymuKiekisIndex ?>] = { value: pasiulymuKiekis.toString(), isDate: false };
    }

    // Ciklas per visus konfigūruotus pasiūlymo stulpelius
    for (var i = 0; i < proposalColumns.length; i++) {
      var col = proposalColumns[i];
      // Ciklas per pasirinktą pasiūlymų kiekį (1, 2 arba 3)
      for (var p = 1; p <= pasiulymuKiekis; p++) {
        var baseColumnName = col.columnName.replace(/1$/, '');
        var targetColName = baseColumnName + p;
        var targetCol = allProposalColumns.find(c => c.columnName === targetColName);

        if (!targetCol) continue;
        var input = document.getElementById("input_" + baseColumnName + "_" + p);
        if (col.editable && input) {
          updates[targetCol.index] = { value: input.value, isDate: false };
        } 
      }
    }

    // Išvalome nebeaktualius pasiūlymų duomenis
    // Ciklas per pasiūlymus, kurie yra didesni nei pasirinktas kiekis (pvz., jei pasirinkta 1, ciklas suksis per 2 ir 3)
    for (var p = pasiulymuKiekis + 1; p <= 3; p++) {
      // Ciklas per visus galimus pasiūlymo stulpelius
      for (var i = 0; i < proposalColumns.length; i++) {
        var col = proposalColumns[i];
        var baseColumnName = col.columnName.replace(/1$/, '');
        var targetColName = baseColumnName + p;
        var targetCol = allProposalColumns.find(c => c.columnName === targetColName);

        if (targetCol) {
          updates[targetCol.index] = { value: "", isDate: false }; // Nustatome tuščią reikšmę
        }
      }
    }

    google.script.run
      .withSuccessHandler(function() { alert("Pasiūlymo duomenys išsaugoti!"); closeModal("proposalModal"); location.reload(); })
      .withFailureHandler(function(err) { alert("Klaida išsaugant pasiūlymą: " + err); })
      .updateSheet1(rowIndex, updates);
  }

  function generateProposal(uniqueId) {
    console.log("generateProposal called for uniqueId: " + uniqueId);
    //alert("Generuojamas pasiūlymas... Tai gali užtrukti kelias sekundes."); 
    google.script.run
      .withSuccessHandler(function(response) {
        if (response && response.success) {
          alert("Pasiūlymas sėkmingai sugeneruotas ir išsaugotas kaip juodraštis Jūsų Gmail paskyroje!");
          // Galima atidaryti Gmail, bet negalima tiesiogiai atidaryti juodraščio
          // window.open('https://mail.google.com/', '_blank');
        } else {
          alert("Įvyko klaida generuojant pasiūlymą. Patikrinkite konsolę.");
        }
      })
      .withFailureHandler(function(err) {
        alert("Klaida generuojant pasiūlymą: " + err);
      })
      .generateProposalDocument(uniqueId);
  }

  function toggleInlineEdit(rowElement) {
    var $row = $(rowElement);
    var nextRow = $row.next();

    // Jei redagavimo forma šiai eilutei jau atidaryta, nieko nedaryti.
    if (nextRow.hasClass('edit-row')) {
      return;
    }

    // Pašaliname visas kitas atidarytas redagavimo formas
    $('.edit-row').remove();

    var originalIndex = $row.data('original-index');
    var data = <?!= JSON.stringify(formattedData.slice(1)) ?>;
    var group1Columns = <?!= JSON.stringify(group1Columns) ?>;
    var group2Columns = <?!= JSON.stringify(group2Columns) ?>;

    var newRow = $('<tr class="edit-row"></tr>');
    var cell = $('<td colspan="' + (<?!= displayNames.length ?> + 1) + '"></td>');
    
    var editFormHtml = '<div style="padding: 20px; background-color: #f9f9f9; border: 1px solid #ddd;"><div id="eilutes_redagavimas">';
    editFormHtml += '<h3>Redaguoti eilutę</h3>';
    editFormHtml += '<table style="table-layout: fixed; word-wrap: break-word;"><tr><th style="width: 200px; max-width: 200px;">Pavadinimas 1</th><th style="width: 250px; max-width: 250px;">Reikšmė 1</th><th style="width: 200px; max-width: 200px;">Pavadinimas 2</th><th style="width: 250px; max-width: 250px;">Reikšmė 2</th></tr>';

    var maxRows = Math.max(group1Columns.length, group2Columns.length);
    for (var i = 0; i < maxRows; i++) {
      var name1 = i < group1Columns.length && group1Columns[i] ? group1Columns[i].displayName : "";
      var value1 = i < group1Columns.length && group1Columns[i] ? (data[originalIndex-1][group1Columns[i].index] || "") : "";
      var inputField1 = (i < group1Columns.length && group1Columns[i] && group1Columns[i].editable) ? createInputField(group1Columns[i], value1) : ("<div class=\"" + (group1Columns[i] ? group1Columns[i].columnName : '') + "_reiksme\">" + (value1 ? value1.toString() : "") + "</div>");

      var name2 = i < group2Columns.length && group2Columns[i] ? group2Columns[i].displayName : "";
      var value2 = i < group2Columns.length && group2Columns[i] ? (data[originalIndex-1][group2Columns[i].index] || "") : "";
      var inputField2 = (i < group2Columns.length && group2Columns[i] && group2Columns[i].editable) ? createInputField(group2Columns[i], value2) : ("<div class=\"" + (group2Columns[i] ? group2Columns[i].columnName : '') + "_reiksme\">" + (value2 ? value2.toString() : "") + "</div>");

      editFormHtml += "<tr><td>" + name1 + "</td><td>" + inputField1 + "</td><td>" + name2 + "</td><td>" + inputField2 + "</td></tr>";
    }
    editFormHtml += '</table>';
    editFormHtml += '<button onclick="saveChanges(' + originalIndex + ')">Išsaugoti</button>';
    editFormHtml += '<button onclick="$(this).closest(\'.edit-row\').remove()">Atšaukti</button>';
    editFormHtml += '</div>'; // eilutes_redagavimas pabaiga

    // --- Pasiūlymo sekcijos pradžia ---
    var proposalFormHtml = '<div id="pasiulymo_generavimas" style="border-top: 2px solid #eee; margin-top: 20px; padding-top: 20px; max-width: 1000px;">';
    var currentRowData = data[originalIndex-1];
    var pasiulymuKiekisOptions = <?!= JSON.stringify(pasiulymuKiekisOptions) ?>;
    var pasiulymuKiekisIndex = <?!= pasiulymuKiekisIndex ?>;
    var proposalColumns = <?!= JSON.stringify(proposalColumns) ?>;

    // Pasiūlymų kiekis
    var pasiulymuKiekisValue = pasiulymuKiekisIndex !== -1 ? (currentRowData[pasiulymuKiekisIndex] || "").toString() : "";
    proposalFormHtml += '<div class="pasiulymai_su_pasiulymu_kiekiu_inline">';
    proposalFormHtml += '<h3>Pasiūlymo duomenys</h3>';
    proposalFormHtml += '<label for="pasiulymu_kiekis_inline">Pasiūlymų kiekis:</label>';
    proposalFormHtml += '<select class="pasiulymu_kiekis_select">' + "<option value=\"\"" + (pasiulymuKiekisValue === "" ? " selected" : "") + "></option>" + pasiulymuKiekisOptions.map(function(opt) { return "<option value=\"" + opt + "\"" + (pasiulymuKiekisValue.toString() === opt ? " selected" : "") + ">" + opt + "</option>"; }).join("") + '</select>';

    // Sugeneruotų pasiūlymų nuorodos
    if (linksIndex !== -1) {
      var linksValue = currentRowData[linksIndex];
      proposalFormHtml += '<div class="pasiulymu_nuorodos_container_inline" style="margin-top: 15px; ' + (linksValue ? '' : 'display: none;') + '">';
      proposalFormHtml += '<strong>Sugeneruotų pasiūlymų nuorodos:</strong>';
      var linksListHtml = '';
      if (linksValue) {
        var linksArray = linksValue.split('\n').filter(function(link) { return link.trim() !== ''; });
        linksListHtml = linksArray.map(function(linkData, i) {
          var parts = linkData.split('|');
          var url = parts[0];
          var date = parts.length > 1 ? parts[1] : '';
          var dateHtml = date ? ' <span style="color: #888; font-size: 0.9em;">(' + date + ')</span>' : '';
          return (i + 1) + '. <a href="' + url + '" target="_blank">' + url + '</a>' + dateHtml;
        }).join('<br>');
      }
      proposalFormHtml += '<div class="pasiulymu_nuorodos_list_inline" style="margin-top: 5px; word-break: break-all;">' + linksListHtml + '</div></div>';
    }

    // Pasiūlymų lentelės
    proposalFormHtml += '<div class="pasiulymai_inline" style="display: flex; flex-direction: row; gap: 20px;">';
    proposalFormHtml += '<table class="pasiulymas1Table"></table>';
    proposalFormHtml += '<table class="pasiulymas2Table"></table>';
    proposalFormHtml += '<table class="pasiulymas3Table"></table>';
    proposalFormHtml += '</div></div>'; // pasiulymai_su_pasiulymu_kiekiu_inline pabaiga

    // Mygtukai
    var uniqueId = currentRowData[idIndex] ? currentRowData[idIndex].toString() : '';
    proposalFormHtml += '<button class="edit-btn" onclick="saveProposalChanges(' + originalIndex + ')">Išsaugoti pasiūlymą</button>';
    proposalFormHtml += '<button class="generate-proposal-btn" onclick="generateProposal(\'' + uniqueId + '\')">Generuoti pasiūlymą</button>';

    proposalFormHtml += '</div>'; // pasiulymo_generavimas pabaiga

    // Sujungiame abi dalis
    editFormHtml += proposalFormHtml + '</div>'; // pagrindinio div pabaiga

    cell.html(editFormHtml);
    newRow.append(cell);
    $row.after(newRow);

    // --- Vykdome JavaScript logiką naujai sukurtai pasiūlymo formai ---
    var $proposalContainer = newRow.find('#pasiulymo_generavimas');
    var modalTable1 = $proposalContainer.find(".pasiulymas1Table")[0];
    var modalTable2 = $proposalContainer.find(".pasiulymas2Table")[0];
    var modalTable3 = $proposalContainer.find(".pasiulymas3Table")[0];
    var pasiulymuKiekisSelect = $proposalContainer.find(".pasiulymu_kiekis_select")[0];

    var html1 = "<tr><th>Pavadinimas</th><th>Reikšmė</th></tr>";
    var html2 = "<tr><th>Pavadinimas</th><th>Reikšmė</th></tr>";
    var html3 = "<tr><th>Pavadinimas</th><th>Reikšmė</th></tr>";
    for (var i = 0; i < proposalColumns.length; i++) {
      var name = proposalColumns[i].displayName || "";
      var baseColumnName = proposalColumns[i].columnName.replace(/1$/, '');
      var value1 = data[originalIndex-1][allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '1'; })?.index] || "";
      var value2 = data[originalIndex-1][allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '2'; })?.index] || "";
      var value3 = data[originalIndex-1][allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '3'; })?.index] || "";
      if (baseColumnName === "pasirinkite_kw" && !value1) value1 = "10";
      var inputField1 = "", inputField2 = "", inputField3 = "";
      var onChangeAttr1 = allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '1'; })?.autoUpdateCell ? "updateProposalSheetCell(1, '" + allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '1'; }).autoUpdateCell.split('!')[1] + "', this.value);" : '';
      var onChangeAttr2 = allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '2'; })?.autoUpdateCell ? "updateProposalSheetCell(2, '" + allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '2'; }).autoUpdateCell.split('!')[1] + "', this.value);" : '';
      var onChangeAttr3 = allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '3'; })?.autoUpdateCell ? "updateProposalSheetCell(3, '" + allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '3'; }).autoUpdateCell.split('!')[1] + "', this.value);" : '';
      if (proposalColumns[i].editable) {
        var options1 = allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '1'; })?.options || [];
        var options2 = allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '2'; })?.options || [];
        var options3 = allProposalColumns.find(function(c) { return c.columnName === baseColumnName + '3'; })?.options || [];
        if (options1.length > 0) {
          inputField1 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><select id=\"input_" + baseColumnName + "_1\" size=\"1\" onchange=\"" + onChangeAttr1 + "\">" + "<option value=\"\"" + (value1 === "" ? " selected" : "") + "></option>" + options1.map(function(opt) { return "<option value=\"" + opt + "\"" + (value1.toString() === opt ? " selected" : "") + ">" + opt + "</option>"; }).join("") + "</select></div></div>";
          inputField2 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><select id=\"input_" + baseColumnName + "_2\" size=\"1\" onchange=\"" + onChangeAttr2 + "\">" + "<option value=\"\"" + (value2 === "" ? " selected" : "") + "></option>" + options2.map(function(opt) { return "<option value=\"" + opt + "\"" + (value2.toString() === opt ? " selected" : "") + ">" + opt + "</option>"; }).join("") + "</select></div></div>";
          inputField3 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><select id=\"input_" + baseColumnName + "_3\" size=\"1\" onchange=\"" + onChangeAttr3 + "\">" + "<option value=\"\"" + (value3 === "" ? " selected" : "") + "></option>" + options3.map(function(opt) { return "<option value=\"" + opt + "\"" + (value3.toString() === opt ? " selected" : "") + ">" + opt + "</option>"; }).join("") + "</select></div></div>";
        } else {
          inputField1 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><textarea id=\"input_" + baseColumnName + "_1\" rows=\"1\" placeholder=\"Įveskite reikšmę\" onchange=\"" + onChangeAttr1 + "\">" + (value1 ? value1.toString() : "") + "</textarea></div></div>";
          inputField2 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><textarea id=\"input_" + baseColumnName + "_2\" rows=\"1\" placeholder=\"Įveskite reikšmę\" onchange=\"" + onChangeAttr2 + "\">" + (value2 ? value2.toString() : "") + "</textarea></div></div>";
          inputField3 = "<div class=\"" + baseColumnName + "_reiksme\"><div class=\"input-container\"><textarea id=\"input_" + baseColumnName + "_3\" rows=\"1\" placeholder=\"Įveskite reikšmę\" onchange=\"" + onChangeAttr3 + "\">" + (value3 ? value3.toString() : "") + "</textarea></div></div>";
        }
      } else {
        inputField1 = "<div class=\"" + proposalColumns[i].columnName.replace(/1$/, '') + "_reiksme\" id=\"input_" + proposalColumns[i].columnName.replace(/1$/, '') + "_1\">" + (value1 ? value1.toString() : "") + "</div>";
        inputField2 = "<div class=\"" + proposalColumns[i].columnName.replace(/1$/, '') + "_reiksme\" id=\"input_" + proposalColumns[i].columnName.replace(/1$/, '') + "_2\">" + (value2 ? value2.toString() : "") + "</div>";
        inputField3 = "<div class=\"" + proposalColumns[i].columnName.replace(/1$/, '') + "_reiksme\" id=\"input_" + proposalColumns[i].columnName.replace(/1$/, '') + "_3\">" + (value3 ? value3.toString() : "") + "</div>";
      }
      html1 += "<tr><td>" + name + "1</td><td>" + inputField1 + "</td></tr>";
      html2 += "<tr><td>" + name + "2</td><td>" + inputField2 + "</td></tr>";
      html3 += "<tr><td>" + name + "3</td><td>" + inputField3 + "</td></tr>";
    }
    modalTable1.innerHTML = html1;
    modalTable2.innerHTML = html2;
    modalTable3.innerHTML = html3;

    function toggleInlineProposalTables() {
      var count = pasiulymuKiekisSelect.value;
      $proposalContainer.find('.pasiulymas1Table').toggle(count >= 1);
      $proposalContainer.find('.pasiulymas2Table').toggle(count >= 2);
      $proposalContainer.find('.pasiulymas3Table').toggle(count >= 3);
    }

    $(pasiulymuKiekisSelect).off('change').on('change', toggleInlineProposalTables);
    toggleInlineProposalTables();

    // --- Nuoseklus duomenų sinchronizavimas ir auto-atvaizdavimo eilučių įkėlimas (INLINE) ---
    if (autoDisplayConfig && autoDisplayConfig.length > 0) {
      var syncData = <?!= JSON.stringify(formattedData.slice(1)) ?>;
      var syncAllProposalColumns = <?!= JSON.stringify(allProposalColumns) ?>;

      // Ciklas per pasiūlymus (1, 2, 3)
      for (let i = 1; i <= 3; i++) {
        // 1. Paruošiame duomenis sinchronizavimui šiam konkrečiam pasiūlymui
        let dataToSync = [];
        proposalColumns.forEach(function(pCol) {
          if (pCol.autoUpdateCell && pCol.autoUpdateCell.includes('!')) {
            var baseColumnName = pCol.columnName;
            var cellAddress = pCol.autoUpdateCell.split('!')[1];
            var fullColumnName = baseColumnName + i;
            var sourceCol = syncAllProposalColumns.find(c => c.columnName === fullColumnName);
            if (sourceCol) {
              var value = syncData[originalIndex - 1][sourceCol.index] || '';
              dataToSync.push({ cellAddress: cellAddress, value: value });
            }
          }
        });

        // 2. Iškviečiame serverio funkciją
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success && response.autoDisplayValues) {
              var $table = $proposalContainer.find('.pasiulymas' + i + 'Table');
              $table.find('.auto-display-row').remove(); 
              response.autoDisplayValues.forEach(function(item, itemIndex) {
                var newRow = "<tr class='auto-display-row' data-item-index='" + itemIndex + "'>" +
                               "<td>" + item.pavadinimas + "</td>" +
                               "<td>" + item.reiksme + "</td>" +
                             "</tr>";
                $table.append(newRow);
              });
            }
          })
          .withFailureHandler(function(err) { console.error(`Klaida sinchronizuojant pasiūlymą ${i} (inline): ` + err); })
          .syncAndGetInitialData(i, dataToSync);
      }
    }

    // Inicializuojame datepicker
    newRow.find(".datepicker").datepicker({ dateFormat: "yy-mm-dd", showButtonPanel: true, changeMonth: true, changeYear: true });
  }

  function createInputField(column, value) {
    var inputHtml = "";
    var id = "input_" + column.columnName;
    var options = column.pasiulymoOptions || column.formulaOptions || column.options || [];
    if (options.length > 0) {
      inputHtml = "<select id='" + id + "' size='" + column.rowCount + "'>" + "<option value='' " + (value === "" ? "selected" : "") + "></option>" + options.map(opt => "<option value='" + opt + "' " + (value.toString() === opt ? "selected" : "") + ">" + opt + "</option>").join("") + "</select>";
    } else if (column.hasDatePicker) {
      var displayValue = value && column.isDateTime && value.includes(" ") ? value.split(" ")[0] : value;
      inputHtml = "<input type='text' id='" + id + "' class='datepicker' value='" + (displayValue || "") + "' placeholder='Įveskite datą'>";
    } else {
      inputHtml = "<textarea id='" + id + "' rows='" + column.rowCount + "' placeholder='Įveskite reikšmę'>" + (value ? value.toString() : "") + "</textarea>";
      if (column.dateButton) {
        var dateValue = new Date().toLocaleString("lt-LT", {timeZone: "Europe/Vilnius", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit"}).replace(", ", " ").replace(/\./g, "-");
        inputHtml += "<button class='date-btn' onclick=\"document.getElementById('" + id + "').value = '" + dateValue + "'\">Dabar</button>";
      }
    }
    return "<div class='" + column.columnName + "_reiksme'><div class='input-container'>" + inputHtml + "</div></div>";
  }

  window.onclick = function(event) {
    var modal = document.getElementById("myModal");
    var proposalModal = document.getElementById("proposalModal");
    if (event.target == modal) { closeModal("myModal"); }
    if (event.target == proposalModal) { closeModal("proposalModal"); }
  }
</script>
</body>
</html>